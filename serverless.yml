service: rak-orion-backend
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  memorySize: 512
  timeout: 29
  environment:
    NODE_ENV: production
    # Variables de Base de Datos
    DB_HOST: ${env:DB_HOST}
    DB_USER_PRODUCTION: ${env:DB_USER_PRODUCTION}
    DB_PASSWORD_PRODUCTION: ${env:DB_PASSWORD_PRODUCTION}
    DB_NAME_PRODUCTION: ${env:DB_NAME_PRODUCTION}
    # Variables de Seguridad y APIs
    JWT_SECRET: ${env:JWT_SECRET}      # <--- Â¡Ojo! La agreguÃ© porque es vital para el Login
    GEMINI_API_KEY: ${env:GEMINI_API_KEY}
    EMAIL_USER: ${env:EMAIL_USER}
    EMAIL_PASS: ${env:EMAIL_PASS}
    # ðŸ‘‡ NUEVO: Variable del Bucket S3
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME}

  # ðŸ‘‡ NUEVO: Permisos IAM dinÃ¡micos (Permite escribir en el bucket que definas)
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
          # AquÃ­ usamos la variable tambiÃ©n para no hardcodear el nombre
          Resource:
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}/*" # Para tocar archivos
            - "arn:aws:s3:::${env:S3_BUCKET_NAME}"   # Para listar el bucket en sÃ­

functions:
  api:
    handler: src/index.handler
    events:
      - http:
          path: /
          method: ANY
          cors: true
      - http:
          path: /{proxy+}
          method: ANY
          cors: true

# ExclusiÃ³n de archivos
package:
  patterns:
    - '!node_modules/sequelize-cli/**'
    - '!.git/**'
    - '!.env'
    - '!tests/**'